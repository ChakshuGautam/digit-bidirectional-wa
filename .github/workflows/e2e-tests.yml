name: E2E Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  e2e-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create .env file
        run: |
          cp .env.example .env
          # Override settings for CI
          echo "MOCK_MODE=true" >> .env
          echo "USE_BAILEYS=true" >> .env
          echo "USE_NOVU_TEMPLATES=false" >> .env

      - name: Start services
        run: |
          docker compose up -d
          echo "Waiting for services to start..."

      - name: Wait for services to be healthy
        run: |
          echo "Waiting for services to become healthy..."

          # Function to check service health
          check_health() {
            local url=$1
            local name=$2
            local max_attempts=60
            local attempt=1

            while [ $attempt -le $max_attempts ]; do
              if curl -sf "$url" > /dev/null 2>&1; then
                echo "✓ $name is healthy"
                return 0
              fi
              echo "Waiting for $name... (attempt $attempt/$max_attempts)"
              sleep 2
              attempt=$((attempt + 1))
            done

            echo "✗ $name failed to become healthy"
            return 1
          }

          # Check all services
          check_health "http://localhost:18200/user-preferences/health" "User Preferences" || exit 1
          check_health "http://localhost:18201/configs/health" "Config Service" || exit 1
          check_health "http://localhost:18202/novu-bridge/health" "Novu Bridge" || exit 1
          check_health "http://localhost:18203/baileys/health" "Baileys Provider" || exit 1

          echo ""
          echo "All services are healthy!"

      - name: Run E2E tests
        id: e2e
        run: |
          chmod +x ./scripts/e2e-tests.sh
          ./scripts/e2e-tests.sh 2>&1 | tee test-output.txt

          # Extract test results
          PASSED=$(grep -oP 'Passed: \K\d+' test-output.txt || echo "0")
          FAILED=$(grep -oP 'Failed: \K\d+' test-output.txt || echo "0")
          TOTAL=$((PASSED + FAILED))

          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

          # Fail if any tests failed
          if [ "$FAILED" != "0" ]; then
            echo "::error::$FAILED test(s) failed"
            exit 1
          fi

          echo "All $PASSED tests passed!"

      - name: Test Summary
        if: always()
        run: |
          echo "## E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.e2e.outputs.failed }}" = "0" ]; then
            echo "✅ **All tests passed!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Some tests failed**" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Passed | ${{ steps.e2e.outputs.passed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Failed | ${{ steps.e2e.outputs.failed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Total | ${{ steps.e2e.outputs.total }} |" >> $GITHUB_STEP_SUMMARY

      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== Docker Compose Logs ==="
          docker compose logs --tail=100

          echo ""
          echo "=== Container Status ==="
          docker compose ps

      - name: Cleanup
        if: always()
        run: |
          docker compose down -v
